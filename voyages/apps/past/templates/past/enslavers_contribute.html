{% extends "_base.html" %} {% load sass_tags %} {% load compress %}

<!-- Basic template for pages in the Voyage section -->
{% load i18n %}
{% block csslist %}
	{% compress css %}
	<link href="{% sass_src 'scss/navbar-site.scss' %}" rel="stylesheet" type="text/css" />
	<link href="{% sass_src 'scss/main.scss' %}" rel="stylesheet" type="text/css" />
	<link href="{% sass_src 'scss/past.scss' %}" rel="stylesheet" type="text/css" />
    <link href="{% sass_src 'scss/off-canvas.scss' %}" rel="stylesheet" type="text/css" />
    <link href="{% sass_src 'scss/search-ui.scss' %}" rel="stylesheet" type="text/css" />
    <link href="{% sass_src 'scss/v-component.scss' %}" rel="stylesheet" type="text/css" />
    <link href="{% sass_src 'scss/trans-search.scss' %}" rel="stylesheet" type="text/css" />
    <link href="{% sass_src 'scss/animations.scss' %}" rel="stylesheet" type="text/css" />
    <link href="{% sass_src 'scss/sidebar.scss' %}" rel="stylesheet" type="text/css" />
    <link href="{% sass_src 'scss/library/loading.css' %}" rel="stylesheet" type="text/css" />
    <link href="{% sass_src 'scss/library/vue-treeselect@0.0.37.min.css' %}" rel="stylesheet" type="text/css" />
	{% endcompress %}
{% endblock %}

{% block title %}
	{% trans 'Contribution to Enslavers Database' %}
{% endblock %}

{% block content %}

<div class="trans-container">
    <div class="col-md-12">
        <div id="center-content-inner" class="enslavers-content">
            <!-- Tabs -->
            <ul class="nav nav-tabs trans-tab">
                <li class="nav-item">
                    <a class="nav-link active" @click="setActive('aliases')" href="#aliases" data-toggle="tab" data-target="#aliases">{% trans 'Aliases and Voyages' %}</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" @click="setActive('personal')" href="#personal" data-toggle="tab" data-target="#personal">{% trans 'Personal information' %}</a>
                </li>
            </ul>
            
            <!-- TabContainers -->
            <div id="tabsJustifiedContent" class="tab-content">
                <div id="aliases" class="tab-pane fade active show">
                    {% include "past-contribute/_enslaver_contrib_aliases.html" %}
                </div>
                <div id="personal" class="tab-pane fade">
                    {% include "past-contribute/_enslaver_contrib_personal.html" %}
                </div>
            </div>
        </div>
    </div>
</div>
<script src="{{ STATIC_URL }}scripts/library/vue@2.6.7.min.js" type="text/javascript"></script>
<script>
    async function initialize() {
        // The interim is either injected via Django view or we need to fetch it
        // based on URL params.
        let interim = {% if interim %}`{{ interim }}`{% else %}null{% endif %};
        if (interim === null) {
            // Initialize an interim Enslaver for this contribution.
            const data = await fetch("/contribute/init_enslaver_interim", {
                method: 'POST',
                body: JSON.stringify({ type: '{{ mode }}', enslavers: [{{ id }}] })
            });
            interim = await data.json();
        }
        const viewModel = new Vue({
            el: "#center-content-inner",
            delimiters: ['[[', ']]'],
            data: {
                interim,
                selectedAlias: null,
                selectedIdentity: interim.identities[Object.keys(interim.identities)[0]],
                selectedVoyage: null,
                linkVoyageInput: null,
            },
            methods: {
                selAlias: function() {
                    if (!this.selectedAlias) {
                        return null;
                    }
                    return this.selectedIdentity.aliases[this.selectedAlias];
                },
                delSelAlias: function() {
                    if (!this.selectedAlias) {
                        return null;
                    }
                    delete this.selectedIdentity.aliases[this.selectedAlias];
                    this.selectedAlias = null;
                },
                moveVoyage: function(event) {
                    const target = this.selectedIdentity.aliases[event.target.getAttribute("value")];
                    if (!target) {
                        return;
                    }
                    const match = this.unlinkVoyage();
                    if (match) {
                        target.voyages.push(match);
                    }
                },
                unlinkVoyage: function() {
                    const source = this.selAlias();
                    if (!source) {
                        return null;
                    }
                    let match = null;
                    source.voyages = source.voyages.filter((val) => {
                        const isMatch = val.voyage__voyage_id === this.selectedVoyage;
                        if (isMatch) {
                            match = val;
                        }
                        return !isMatch;
                    });
                    if (match) {
                        this.selectedVoyage = null;
                    }
                    return match;
                },
                linkVoyage: async function() {
                    if (this.linkVoyageInput) {
                        const res = await fetch("/contribute/voyage_ajax", {
                            method: "POST",
                            body: JSON.stringify({ voyage_id: parseInt(this.linkVoyageInput) })
                        });
                        const data = await res.json();
                        this.selAlias().voyages.push({
                            
                        });
                    }
                }
            }
        });
    }
    try {
        initialize();
    } catch {
        alert("An error has occurred");
    }
</script>
{% endblock %}